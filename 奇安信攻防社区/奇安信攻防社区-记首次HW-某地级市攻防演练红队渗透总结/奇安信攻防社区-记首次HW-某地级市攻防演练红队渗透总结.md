

# 奇安信攻防社区 - 记首次 HW|某地级市攻防演练红队渗透总结

### 记首次 HW|某地级市攻防演练红队渗透总结

团队协作，我们打上了云，打进了 IOT！

**申明：文章仅供技术交流，请自觉遵守网络安全相关法律法规，切勿利用文章内的相关技术从事非法活动，如因此产生的一切不良后果与文章作者无关**

# 0x00 前言

上周参加了某地级市为期七天的网络攻防演练对抗赛，总共 14 支攻击队。大概情况是：第一天多为弱口令和应用层漏洞攻击且有攻击队申请高危漏洞攻击，之后想必都开始了高危漏洞利用，内网攻击，第四天就有攻击队开始使用 0 day,Nday，社工钓鱼攻击，从第五天凌晨起进入混打乱斗模式，所有目标都变为公共目标，第七天 18 点停止对所有攻击队的授权，所有攻击队停止攻击，演练结束。最终评判结果是第三名五万多分，第二名六万多分，第一名七万多分！！！太太太......太卷了！！！

作为一只初次参加 HW 的菜鸟选手，在惊叹的同时也在思考和摸索着红队渗透该怎么玩？他们是怎么打得那么快的？他们为什么能打穿内网，能单兵 APT？陷入了对生命终极回答的思考：我是谁？我在哪？我要如何去往红队之路？

总的来说，在此次 HW 行动中还是学到了不少东西。故才有了本文，意在对此次 HW 进行复盘，总结在这次 HW 中学到的东西以及自己的不足与改进方法，也想做一次分享，希望能同安全圈的各位师傅们一同探讨红队之路怎么走，在攻防演练中作为攻击方我们应当做些什么才能达到 HW 演练所要达到的效果。以下是本人的总结与思考：

# 0x01 对某目标攻击的复盘

由于 HW 中涉及的目标都很敏感，故本文截图较少，且都已进行脱敏处理。有些内容可能不太完整，望见谅~  
就拿得分最高也是最有意思的一个目标来做下复盘吧，整个的攻击过程和方法是这样的：

## 1.Web 打点

目标是一个 asp.net 的网站，能解析 asp,aspx 代码，访问时就只能看到一个登录框。大佬 A 的一顿操作发现了未授权访问 (算是 0day 了吧，采用此程序搭建的其他系统都存在这个问题，且似乎只有我们团队发现了这个)，此程序存在未授权用户查看、添加、编辑和删除。通过未授权访问用户修改界面 (用户 uid=1)，可以看到密码已填充，以\*号显示，通过前端代码可以查看到明文，于是获得后台管理员账号密码并成功登录，获得 200 分。

在未授权用户编辑界面有一个上传头像的功能，此处存在文件上传漏洞，上传图片马，burp 抓包将后缀改为 asp 即可绕过，返回状态码为 500，但实际上文件是上传成功了的。

这是怎么知道文件上传成功了的呢？通过目录遍历漏洞找到文件上传路径：  
![image.png](assets/1698900793-73ed32ceaa5f2e773d3ce11198f45b50.png)

通过时间比对找到我们上传的木马文件是哪个，接下来就是常规操作，用蚁剑连接成功。又获得 200 分！

不得不说，未授权访问-->文件上传-->目录遍历-->拿到 webshell，大佬 A 强啊！！！

## 2.上免杀马反弹 shell(Failed)

拿到的是一个 IIS 权限，自然是要反弹到 Metasploit、CobaltStrike 这类集成框架来进行后渗透、提权打内网了（虽然内网也没啥主机，但就是想打）。执行 Systeminfo 查看到是一台 winserver 2012 R2 的服务器，打了 153 个补丁，通过执行 tasklist /svc 查看当前主机上运行的进程，将结果拷贝到在线杀软识别平台进行比对，发现目标主机上装了 360。

![360 防护.png](assets/1698900793-3d97b4afef2e53aa42543d6a895cbf24.png)

感觉有戏，于是我之前花了两天研究的 C 语言免杀派上用场了，上传了免杀 360 的马，是 shellcode 分离免杀的，目标上提示命令执行成功但没反弹回来，但在自己环境中能执行上线。不是被拦截原因，后面有场景会说明（相信有大佬大概知道什么原因了）。反弹失败，还是我菜的原因啊~

## 3.信息收集，数据库提权

通过信息收集，发现了这套程序还搭建在了其他目标上，于是大佬 A 又用之前的方法拿到了一台主机的 webshell，通过比对，发现装了火绒。

![火绒防护.png](assets/1698900793-5b9f59428b770592977f84681e4512a9.png)

于是再次用我的免杀马尝试 CobaltStrike 上线，这次成功了!!!

![web2.png](assets/1698900793-23e555292faeee6f888d051361ff8179.png)

接下来提权，拿到的也是一台 winserver 2012 R2 的服务器，打了 150 个补丁，我加载了 taowu 和 Lodan 插件 (20211024 版，应该是开源的最后一版了吧)，试过了里面常用的提权插件都未成功，烂土豆提权失败，因为条件不满足；ms14-058 反弹回来的是一样的权限。（这是拿到数据库服务器，演练快结束时的事了：将会话移交给 MSF，使用 MSF 内置的 CVE-2020-0787 提权未成功，使用 post/windows/gather/enum\_patches 模块来收集补丁信息，显示补丁都是在 2021.12.1 日打的；使用 post/multi/recon/local\_exploit\_suggester 来查询哪些 EXP 可用，并没有显示有可用 EXP。）

陷入窘境，大佬 B 通过信息收集翻到了数据库配置文件，原来这是一台站库分离的系统，数据库在另外一台外网服务器上 (阿里云服务器)，配置文件中泄露了数据库服务器 IP，端口，账号，密码，为 SA 权限，使用 Navicat 尝试连接，居然成功了!!! 获得 400 分  
大佬 C 立马来个 xp\_cmdshell 提权，成功拿到 System 权限，再获得 200 分！

![3.sqlserver 提权.png](assets/1698900793-ddf0095a28b26f98d7cd0d7ca5cf175e.png)

System 权限是在数据库中，为了方便接下来的渗透，思路是将 System 权限上线到 CobaltStrike 上，在此处执行了从自己的 VPS 上下载免杀木马并执行的操作，显示执行成功，但并未上线。猜测这是台阿里云的 ECS，对出站端口进行了限制，所以反弹不回来。

## 4.拿下数据库云服务器

Shell 反弹不回来，就不能对云服务器做更好的控制，不能算完全拿下，于是在大佬 D 的指导下，利用 System 权限创建一个管理员账户，然后 3389 远程桌面连接 (没错 3389 开着，还没对连接地址做限制)，再利用 Procdump+mimikatz 获取到 Administrator 账户的明文密码。(因为是 win2008 的服务器，所以可以获取到明文密码，08 之后的服务器获取到的就是密文的了)。这样才算是完全控制了这台云服务器。

为了探究为什么执行木马的命令提示成功了，但 shell 却没反弹回来的真正原因，在图形化下的 cmd 窗口执行木马，惊人发现：提示缺少了某 140D.dll，这才恍然大悟，这情况去年做 python 免杀实验时也遇到过，原来这是生成 exe 文件时的配置问题，当我们生成 Release 版本的时候，运行库选择 MT；当生成 Debug 版本时，运行库选择 MTD。不然的话就会造成在自己电脑上执行没问题，但在其他电脑上执行可能会提示缺少 dll 文件。于是重新生成了木马，再次在 Navicat 里执行，它居然上线了！它上线了！上线了！

![image.png](assets/1698900793-8c2d4ad72a70eb928ed71520505b4d8b.png)

真实作战环境，看到自己的 CobaltStrike 上线了一台 System 权限的主机，就感觉很刺激~

![system 图形.png](assets/1698900793-2b84ebfff0fe16ba8f645bf196987e10.png)

那之前有 360 防护的那台，是不是也是这个原因了，于是重新生成了木马，但传上去提示 500 错误，怎么肥事？后来在自己的虚拟机里用 360 查杀了下 ( 正经人谁会在自己物理机上装 360，狗头)，我的马已经不免杀了，因为距离上次传的马，已经过了一天了。

## 5.内网横向 (云内漫游？)

接下来自然是横向移动了，由于这是台存储数据的服务器 (内网地址 10.26.179.186)，猜测这应该是个数据库段，要是把内网整个拿下，那分数不得蹭蹭往上涨，在进行了常规的端口扫描之后（扫描中提示可能有防火墙），发现确实存在好几台内网机器，且基本都开放的 80,443 端口，一两台还开放了 21,22 端口。咦？不对呀，内网横向常见的 135,139,445 端口没了？那只能通过内网的 web 渗透来拿权限了？于是搭建了个代理，在本机上挂上代理通过浏览器去逐个访问网站，不对呀，与 HW 完全不搭边呐，都是别的地方的东西，还有个个人博客，通过 admin/123456 进入了后台。我看刑，有判头。

![](assets/1698900793-3f4ac47c84631ba1c9b82b5c8399fb39.png)

至此，裁判评分：

![](assets/1698900793-28996bd88d1a092e28434091056f1d63.png)

打得这么辛苦，就 1000 分？

## 6.咋就打进了 IOT？

大佬 B 再次对拿下的云服务器进行信息收集，远程登录 Administrator 账户，通过谷歌浏览器收集到了访问某个站点的账号密码，是个单点登录，登录进去看到了这样的字眼：登录成功，您已成功登录中央认证系统。又通过服务器上的向日葵远控到另一台主机，上面还显示着某些运行情况。  
裁判评分：

![image.png](assets/1698900793-6102ff9e18894d4eb8d152d2bcecc5a1.png)

看到这个 IOT 整个团队一开始都有点懵的，后面想明白了，这个数据库服务器是很多个系统的数据存放地，可以说是个集群数据库了，有 20 多个 G，而向日葵又远程着另一台服务器，上面监控着运行情况。

## 7.疑似境外攻击？

当我在复盘此次 HW 攻击过程时，在与大佬 B 交流过程中，他说他当时通过 netstat 发现了一个与美国的连接，还将连接情况本地保存了一下，我瞬间感觉有点不太妙，查了下这个 ip:

![image.png](assets/1698900793-2f6c2a05825b2ac71a91e71af1f34191.png)

通过威胁情报中心查询到的结果：

![微步.png](assets/1698900793-197cf6ae37c43fc12103780b0c318c65.png)

![360.png](assets/1698900793-e58b7334c9eb7ea459a25ad0fab92c33.png)

![绿盟.png](assets/1698900793-ab7e4292b68fd1335166fd5d267ae12c.png)

立即将情况上报给警官  
维护国家网络安全，人人有责！

# 0x02 知识点总结

## 1.未授权访问

未授权访问漏洞，是在攻击者没有获取到登录权限或未授权的情况下，或者不需要输入密码，即可通过直接输入网站控制台主页面地址或者不允许查看的链接便可进行访问，同时进行操作。  
一个页面对用户身份的判断基于两种方式：一种是将身份验证代码写入当前文件；另一种是写一个身份验证的代码文件，然后其他页面需要调用时，直接包含进来即可。  
当写了身份验证代码，但开发者在开发时忘了将身份验证的代码文件包含进来，就会造成未授权访问，asp/aspx 的网站通常会有这样的问题。

## 2.SQL Server xp\_cmdshell 提权

xp\_cmdshell 是一个开放接口，可以让 SQLserver 调用 cmd 命令。此存储过程在 SQLserver2000 中默认开启，2005 本身及之后的版本默认禁止，所以想要使用该存储过程，就需要拥有 SA 账号相应权限，使用 sp\_configure 将其开启。

启用 xp\_cmdshell:  
EXEC sp\_configure 'show advanced options', 1  
RECONFIGURE;  
EXEC sp\_configure 'xp\_cmdshell', 1;  
RECONFIGURE;

执行命令：  
EXEC master.dbo.xp\_cmdshell 'whoami'

### 注：

2005 的 xp\_cmdshell 的权限一般是 system，而 2008 多数为 nt authority\\network service。故 xp\_cmdshell 的提权前提为两个：(1) 拿到 sa 权限的账户密码；（2）sqlserver 服务未降权  
SQL Server 提权详情请参考：[https://blog.csdn.net/u014029795/article/details/116910134](https://blog.csdn.net/u014029795/article/details/116910134)

## 3.Procdump+mimikatz 配合抓取密码

Procdump 是微软官方工具，不会被杀软查杀，其抓取密码的原理是获取内存文件 lsass.exe 进程 (它用于本地安全和登陆策略) 中存储的明文登录密码并存储到 lsass.dmp 文件中，之后我们就可以使用 mimikatz 去读取 lsass.dmp 获取到明文密码。  
win10 或 2012R2 以上操作要麻烦一些，具体请参考：  
[https://blog.csdn.net/qq\_44881113/article/details/120315448](https://blog.csdn.net/qq_44881113/article/details/120315448)

### 小 tip:

在进行远程桌面时，为了能够将我们本地的程序或文件拷贝到远程的主机上，应在本地资源中勾选上驱动器：  
![远程.png](assets/1698900793-78b7fc95915757105b7bc81a92bdb53d.png)

## 4.木马文件执行时提示缺少某个 dll 文件

前面说到过当生成 C 的 exe 文件时，如果要生成 Release 版本，运行库选择 MT；生成 Debug 版本时，运行库选择 MTD。那么原理是什么呢？可以参考这篇文章：[https://blog.csdn.net/Celestial\_empire/article/details/106795200](https://blog.csdn.net/Celestial_empire/article/details/106795200)  
简单的理解就是 MT,MTD 是静态链接，它把程序运行时所需要的 dll 库文件都打包好，MT 适用 Release,MTD 适用 Debug。MD,MDD 是动态链接，会在运行的电脑上去动态加载所需的 dll 库文件，如果没有的话，就会提示缺少库文件。

## 5.CobaltStrike 从内存加载.NET 程序集

当我想使用MS16-075烂土豆提权时，最初的想法是将提权的exe脚本传到目标主机然后执行，但目标主机有火绒，MS16-075早已被杀烂，网上找到的代码也都是c#的，看不懂，不知咋改。这时请教了木佬，才知道可以不用做免杀。

原来，在 CobaltStrike 中有一个名为”execute-assembly”的命令，能够从内存中加载.NET 程序集。这个功能不需要向硬盘写入文件，十分隐蔽，可以用来躲避杀软。我们用的 CobaltStrike 提权插件也是基于这个来实现的。具体的原理有待好好研究，这里给出从网上找到的三篇文章，给想研究的师傅们做个参考：  
[https://3gstudent.github.io/%E4%BB%8E%E5%86%85%E5%AD%98%E5%8A%A0%E8%BD%BD.NET%E7%A8%8B%E5%BA%8F%E9%9B%86(execute-assembly)%E7%9A%84%E5%88%A9%E7%94%A8%E5%88%86%E6%9E%90](https://3gstudent.github.io/%E4%BB%8E%E5%86%85%E5%AD%98%E5%8A%A0%E8%BD%BD.NET%E7%A8%8B%E5%BA%8F%E9%9B%86(execute-assembly)%E7%9A%84%E5%88%A9%E7%94%A8%E5%88%86%E6%9E%90)  
[https://www.freeaihub.com/post/59039.html](https://www.freeaihub.com/post/59039.html)  
[https://www.anquanke.com/post/id/220456](https://www.anquanke.com/post/id/220456)

## 6.CobaltStrike 与 Metasploit 之间的会话传递

CobaltStrike 与 Metasploit 作为红队评估的两大常用框架，各有其优缺点：Metasploit 模块众多，但一次只能接受一个反弹回来的 shell，显得有些笨重，不适合团队作战；CobaltStrike 一个监听器可同时接收多个反弹回来的 shell，适合团队作战，但其后渗透模块少，即使使用插件也难以弥补这个缺点，所以经常会需要在这两者之间进行会话传递。具体的原理和操作，可以参考这篇文章：  
[http://blog.leanote.com/post/snowming/43cef4b64cbd](http://blog.leanote.com/post/snowming/43cef4b64cbd)

# 0x03 两个待解决的问题

## 1.只允许本地连接的 SQL Server 数据库提权

在我们拿到的 WEBServer 主机上其实有一个只允许本地连接的 SQL Server 数据库，翻阅目录可以查看到连接的账号密码，权限为 SA，我在 webshell 中使用命令行连接工具 osql 和 sqlcmd 尝试去连，都提示 sa 用户登录失败 (账号密码无误)，在冰蝎的数据库管理模块能连上，但执行提权操作时卡了；在蚁剑中也是能连上，执行提权操作时提示“ODBC 驱动程序不支持所需的属性错误”，按照这篇文章改了蚁剑的代码也没能成功：[https://blog.csdn.net/Ca3tie1/article/details/103605485](https://blog.csdn.net/Ca3tie1/article/details/103605485)

最后大佬 D 上传了一个大马就提权成功了，不过拿到的是 nt authority\\network service，所以本地的 SQL Server 是降权运行的。这里的问题是同样都是本地，为什么 osql,sqlcmd 命令连不上数据库，蚁剑和冰蝎提权失败，使用大马就可以？

## 2.关于云服务器

拿到的云服务器有个内网环境，但内网里的主机上的业务与拿下的目标完全搭不上边，可以说是完全不相关的系统。我们知道，我们自己买的云服务器都会有个内网地址，这是不是说云服务器都有一个内网环境，我们可以通过自己的这台云服务器访问到其所处内网主机的一些资源？但这些内网主机又不是共享一个外网地址？我们知道，当我们反弹回连 shell 的时候，输入我们自己的 VPS 地址是能确切的回连到我们的云服务器的，那如果这些内网主机不共享一个外网地址，又为什么会将这些主机组成一个内网呢？想不明白，这是不是涉及到了云架构、云安全领域？

上面两个问题如果有知道的师傅还请麻烦解答一下，我将思考和探究这两个问题，如果解决了后续会在公众号发文。

# 0x04 关于红队渗透的探索与想法

红队渗透我认为是目前在合法范围内最贴近于实际的，效果真实猛烈，以拿权限，打穿为目的来评估系统的安全防护能力。那么红队的打法流程是怎样的呢？我这里没啥经验，暂时不敢妄加言论，之前看到 Teamssix 师傅的文章有谈到过这个问题，这里先附上师傅之前的连载文章：  
1.浅谈红队中的外网信息收集：  
[https://mp.weixin.qq.com/s/oKDDrFz180tmaTecQog8qA](https://mp.weixin.qq.com/s/oKDDrFz180tmaTecQog8qA)  
2.浅谈红队中的打点：  
[https://mp.weixin.qq.com/s/y6VyyJJUFzD8sQom-1Cn6Q](https://mp.weixin.qq.com/s/y6VyyJJUFzD8sQom-1Cn6Q)  
3.浅谈红队中的权限维持：  
[https://mp.weixin.qq.com/s/3RhX3wiJt4cwLx73\_wcjyw](https://mp.weixin.qq.com/s/3RhX3wiJt4cwLx73_wcjyw)  
4.浅谈红队中的提权：  
[https://mp.weixin.qq.com/s/wtVDjDxwpJyHStoJfNzDRg](https://mp.weixin.qq.com/s/wtVDjDxwpJyHStoJfNzDRg)

对于此次攻防演练的反思，我觉得红队在这个过程当中不能仅仅痴迷于拿权限，打穿内网，还有重要的一点就是当我们拿下一个目标之后，能否寻找下目标之前是否有被攻击过的痕迹？查看下是否有异常的对外连接，异常的进程？公安部每年牵头举办的 HW 行动，其初衷是想通过业内大佬的专业评估来寻找到政府、国企、央企、事业单位等重要系统薄弱环节，帮助其提升防护能力，避免受到来自外界尤其是国外 APT 组织的恶意攻击。HW 不应成为各个公司激烈角逐的战场，更不应是安全从业者的噩耗 (据说每年 HW 中总会猝死那么一两个)。

上面仅是一个菜鸟选手对 HW 红队渗透的一点小想法，大佬不喜，请轻喷~

# 0x05 不足与改进方法

参加此次攻防演练，从中发现了自己许多不足的地方，特此提出来以期下次改进：

## 1.漏洞发现，外网打点能力弱

在整个 HW 过程中，自己仅发现一个普通权限的 sql 盲注，同事能找到弱口令登入后台，能找到 shiro 反序列化，而我却一个弱口令都没碰到。  
改进：有时可能不是技术上的问题，是想法和思路的问题。这个只能在平时的渗透中多注意、多思考一些，也可以通过对 SRC 的挖掘来提升这方面能力。

## 2.知识遗忘或掌握不牢固

相关知识点有学过，也实操过，遗忘了，没想到或者在用到时发现自己其实对于这方面知识点其实也不太熟  
改进方法：平时空闲时多做一些靶机测试，多练，熟悉从外网打点到提权，内网横向获取内网所有主机权限的这一套流程。据我所知，相关不错的靶场国内的有红日安全 ATT&CK 系列靶场，暗月靶场，国外的有 vulnhub，hackthebox。这点得向 dayu 师傅学习，之前天天打 HTB

## 3.攻击方式单一

这不仅是我，也是我们整个团队所存在的问题，都是通过传统的 web 来撕开口子。  
改进：多学习了解红队的一些打法，学学钓鱼、社工，平常做做实验。

如果有想一起讨论红队渗透，一起走向红队之路的师傅们，欢迎通过关注公众号：沃克学安全，添加小编微信好友哦~，感谢关注与支持，您的点赞是我最大的动力。

注：原文首发于先知社区，原文链接：[记首次 HW|某地级市攻防演练红队渗透总结 - 先知社区 (aliyun.com)](https://xz.aliyun.com/t/11300)
