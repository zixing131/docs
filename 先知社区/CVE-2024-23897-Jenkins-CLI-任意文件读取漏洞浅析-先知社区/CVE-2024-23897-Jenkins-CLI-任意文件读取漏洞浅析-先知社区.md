

# CVE-2024-23897 Jenkins CLI 任意文件读取漏洞浅析 - 先知社区

CVE-2024-23897 Jenkins CLI 任意文件读取漏洞浅析

- - -

# 分析调试

根据官方通告描述，漏洞出现在 Jenkins CLI 请求参数解析的时候，关于 Jenkins CLI：[Jenkins CLI](https://www.jenkins.io/doc/book/managing/cli/ "Jenkins CLI ") ，首先在本地下载 cli 客户端，访问 jenkins 服务的`http://localhost/jnlpJars/jenkins-cli.jar`  
支持的指令如下  
[![](assets/1706958033-a86de2a8d35907699552b55647865baf.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240131185614-5a16af30-c027-1.png)  
客户端随便发送一个指令

```plain
java -jar jenkins-cli.jar -s http://localhost:8088 list-plugin
```

jenkins服务端在hudson.cli.CLIAction#doWs对客户端的websocket请求进行响应  
[![](assets/1706958033-28fcc8b399272b36cfd8667a13f81f90.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240131185827-a96772a4-c027-1.png)  
这里的 WebSockets.isSupported 方法默认返回 true，于是走到下边 else 中，这个线程里，调用了 hudson.cli.CLIAction.ServerSideImpl#run  
[![](assets/1706958033-25e8361319fd917d78803fa7f8f476cd.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240131185938-d3d4ac32-c027-1.png)  
run方法里又调用了hudson.cli.CLICommand#main方法，这里会根据`args[0]`获取 commandName，并且解析出 CLICommand 类型  
[![](assets/1706958033-203b7ca37b0bcda8de75ce4ba6723fc9.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240131190006-e43546f4-c027-1.png)  
这里获取的逻辑是，遍历所有 CLICommand 的接口类型，取出 Command 之前的 name，遇到大写就用`-`进行分割，然后全部转为小写（WhoAmICommand 对应的命令就是 who-am-i）  
[![](assets/1706958033-d412a339c14472d14ade95231db2f2bd.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240131190031-f35e5044-c027-1.png)  
这里调用了 all 方法，找到所有 CLICommand.class 的实现类型，这里除了 Command，还有 CLIRegister 类型，对应的 name 为：

```plain
keep-build
restart
shutdown
safe-shutdown
disable-job
enable-job
```

[![](assets/1706958033-272af88c650dbd32b86adf982934b37d.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240131190113-0c72d4ec-c028-1.png)  
然后，调用了 Command 的 main 方法，这里获取了 CmdLineParser，并在后面解析 args  
[![](assets/1706958033-8f66fe032a850d9950ae2bdaeb39dc01.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240131190138-1b7edf80-c028-1.png)

## 无权限情况

### CLICommand

这里需要注意，使用 CLICommand，如果不是 HelpCommand 或者 WhoAmICommand 的时候，会进行身份检测，所以我们传入`who-am-i`就能直接进入 parseArgument 进行参数解析。  
在 parseArgument 里，atSyntax 默认为 true，所以就会调用 expandAtFiles，最终造成文件读取  
[![](assets/1706958033-43d4c1bb401df2ac8af30173ac1c9d52.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240131190212-2faad8ec-c028-1.png)  
于是我们传入

```plain
java -jar jenkins-cli.jar -s http://localhost:8088 who-am-i @/etc/passwd
```

但是发现只能获取到第一行的内容  
[![](assets/1706958033-2218215f19c9c8e67382483db4feb7c0.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240131190329-5d61e60e-c028-1.png)  
因为在 expandAtFiles 读取完文件内容，会将内容转为 String 数组，每一行就是一个元素，然后 cmdLine 里就是文件的内容  
这里会进行遍历，调用 isOption  
[![](assets/1706958033-336878e90d560d6e7b3536ed450a73ac.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240131190347-6851ef46-c028-1.png)  
如果没有以`-`开头就会返回 false  
[![](assets/1706958033-bd3883f1aae1ca8ba78574426d9cfda1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240131190412-76f5ae84-c028-1.png)  
进入第一个 if，而 argumens 这个值在这里 size 是 0，就会进入 throw 报错，就只会抛出第一行内容，官方通告中也有提到  
[![](assets/1706958033-24a1489993cd94a58a8257ae2cf25764.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240131190439-87610872-c028-1.png)  
Argument 是一个注解，比如 HelpCommand  
[![](assets/1706958033-e05c25ab7ca62cde95457b195e292337.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240131190455-90b7f6ba-c028-1.png)  
如果换成 HelpCommand，这里能读到两行

[![](assets/1706958033-d4d8a4c32d26406c35f9e63f8b74c99c.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240131190526-a375a1c6-c028-1.png)  
原因是当存在 arguments 的时候，会调用 parseAruments，然后把我们传入的设置到 CLICommand 的 COMMAND 属性上，然后输出出来，所以，能读取到的行数取决于 Command 支持的参数`[个数+1]`，没有权限的情况下，使用 WHOAMI 和 HELP，最多只能读到两行  
[![](assets/1706958033-4ca5594d2563510f211af244761fa4d1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240131190542-acc3d658-c028-1.png)  
[![](assets/1706958033-c76444a1fd23e54dceb760dc0384eb26.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240131190554-b4310348-c028-1.png)  
输出逻辑是在 parseArgument 抛出 CmdLineException 之后，在 printUsage 里打印到终端  
[![](assets/1706958033-f45824331ce462e179abe4dc5d96e6e8.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240131190612-be6e4082-c028-1.png)

### CLIRegister

这里是 hudson.cli.declarative.CLIRegisterer 的 main 方法，这里就没有之前 who-am-i 和 help 的限制了，所以使用 register 的那几个命令，也可以读取第一行，调用 parseArgument 的逻辑和上面一样  
[![](assets/1706958033-a7869b8c3b631af229a1433e6a4d1155.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240131190642-d0b8bed4-c028-1.png)

## Overall/Read 权限

（管理员可以勾选 Allow anonymous read access 来开启权限）  
[![](assets/1706958033-6216767910b75e0d01cc9b3b9d89f6f2.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240131190709-e061cb46-c028-1.png)

在寻找 Command 的过程中，找到了支持 multiValued 的 Argument

```plain
OfflineNodeCommand
ConnectNodeCommand
ReloadJobCommand
OnlineNodeCommand
DeleteNodeCommand
DeleteViewCommand
DisconnectNodeCommand
DeleteJobCommand
```

以 hudson.cli.ConnectNodeCommand 为例  
[![](assets/1706958033-5db9937f19490e03cf1a2a4d2e0b0b21.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240131190744-f53fae8e-c028-1.png)

传入有 read aceess 权限的用户或者目标服务器开启了 Allow anonymous read access，指定 connect-node，能够读取到所有行的内容

[![](assets/1706958033-b655f2cc045bdf2386aa0f12af84b8ba.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240131190909-281f0502-c029-1.png)  
来看下原因，回到 org.kohsuke.args4j.CmdLineParser#parseArgument，在遍历 arguments 的时候，只要 multiValued 为 true，这里的 argIndex 就不会增加，就不可能满足 argIndex >= arguments，所以不会抛 CmdLine 异常

[![](assets/1706958033-361760daf0dc337ed6e03e659342769e.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240131190923-308a1f38-c029-1.png)

调用 setter 直到把文件内容处理完

[![](assets/1706958033-aba3f35c1d8bf814c7796197c3370b4d.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240131190937-3920f158-c029-1.png)

[![](assets/1706958033-3bc1d9657f5134ed336ed2db07f8c281.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240131190944-3ce859d4-c029-1.png)

接着，调用当前 Command 的 run 方法  
[![](assets/1706958033-6833f77f9f88119f615b12a425a68612.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240131191029-57f41920-c029-1.png)

hudson.cli.ConnectNodeCommand#run，会遍历 nodes，也就是之前设置的文件内容  
[![](assets/1706958033-cec1ffd7ad7e12386a14d0e8eb556654.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240131191043-600750d2-c029-1.png)  
resolveForCLI 失败就会抛出异常，并打印 nodes，这里 throw/catch 的异常在 while 循环内部，不会退出循环，就会继续处理 nodes，直到打印完所有异常。  
[![](assets/1706958033-fc7b88b65377d582620e58d44b3a1e3a.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240131191059-69b4fad0-c029-1.png)
